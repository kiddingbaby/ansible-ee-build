---
# BIND9 Role

- name: Install bind9
  ansible.builtin.apt:
    name:
      - bind9
      - bind9-utils
      - dnsutils
    state: present
    update_cache: true

- name: Create logging directory
  ansible.builtin.file:
    path: "{{ bind9_logging_file | dirname }}"
    state: directory
    owner: bind
    group: bind
    mode: '0755'
  when: bind9_logging_enabled

- name: Deploy named.conf
  ansible.builtin.template:
    src: named.conf.j2
    dest: /etc/bind/named.conf
    owner: root
    group: bind
    mode: '0644'
    validate: named-checkconf %s
  notify: Restart bind9

- name: Deploy named.conf.options
  ansible.builtin.template:
    src: named.conf.options.j2
    dest: /etc/bind/named.conf.options
    owner: root
    group: bind
    mode: '0644'
  notify: Reload bind9

- name: Deploy named.conf.local
  ansible.builtin.template:
    src: named.conf.local.j2
    dest: /etc/bind/named.conf.local
    owner: root
    group: bind
    mode: '0644'
  notify: Reload bind9

- name: Deploy zone files
  ansible.builtin.template:
    src: zone.j2
    dest: "{{ zone.file }}"
    owner: root
    group: bind
    mode: '0644'
  loop: "{{ bind9_zones }}"
  loop_control:
    loop_var: zone
  when: zone.records is defined
  notify: Reload bind9

- name: Start and enable BIND9
  ansible.builtin.systemd:
    name: named
    state: started
    enabled: true
    daemon_reload: true
