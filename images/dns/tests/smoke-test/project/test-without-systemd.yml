---
# Simplified test to verify BIND9 collection integration
- name: Preflight checks for BIND9 deployment
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Ensure dns_servers group exists
      assert:
        that:
          - "groups['dns_servers'] is defined"
          - "groups['dns_servers'] | length > 0"
        fail_msg: "No hosts defined in 'dns_servers' group; check inventory."

    - name: Verify role structure in collection (local)
      ansible.builtin.stat:
        path: "/usr/share/ansible/collections/ansible_collections/kiddingbaby/bind9/roles/bind9/tasks/{{ item }}"
      loop:
        - main.yml
        - install.yml
        - configure.yml
        - deploy_custom_configs.yml
      register: role_files

    - name: Confirm all role files exist
      ansible.builtin.assert:
        that:
          - item.stat.exists
        success_msg: "✓ Role task file '{{ item.item }}' verified"
        fail_msg: "✗ Role task file '{{ item.item }}' not found"
      loop: "{{ role_files.results }}"

- name: Test BIND9 deployment to remote host
  hosts: dns_servers
  become: yes
  gather_facts: yes
  tasks:
    - name: Display target host info
      ansible.builtin.debug:
        msg: "Testing on {{ ansible_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})"

    - name: Install python3-apt (required for apt module)
      ansible.builtin.raw: apt-get update && apt-get install -y python3-apt
      changed_when: false

    - name: Check if bind9 packages are available
      ansible.builtin.apt:
        name:
          - bind9
          - bind9utils
          - bind9-doc
        state: present
        update_cache: yes
      check_mode: yes
      register: bind9_packages

    - name: Report package status
      ansible.builtin.debug:
        msg: "✓ BIND9 packages are available for installation"

    - name: Final success message
      ansible.builtin.debug:
        msg: "✓✓✓ ansible-bind9 collection is properly integrated and ready for deployment ✓✓✓"
      run_once: yes
